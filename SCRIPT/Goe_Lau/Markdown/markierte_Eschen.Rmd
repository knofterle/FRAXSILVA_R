---
title: "Markierte Eschen"
author: "Johannes Osewold"
date: '2023-05-04'
output:
  html_document: default
  pdf_document: default
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
library(dplyr)
source(file = "SCRIPT/Goe_Lau/Combine_NV_2021_2022.R", local = knitr::knit_global(), encoding = "UTF-8")
```

## Grobe Zahlen zu den markierten Eschen

Für die markierten Eschen konnte der genaue Erkrankungsverlauf zwischen
2021 und 2022 nachverfolgt werden. Die folgende Tabelle bildet die
jeweiligen Teilmengen die 2021 und 2022 krank waren, gesund geblieben
sind oder ihren Status verändert haben.

```{r table, echo=F, warning=F, message=FALSE}
gesund <- nv_marked %>% 
	filter(ETS_21 == F) %>% 
	filter(ETS_22 == F) %>% 
	filter(Gefunden == T) %>% 
	nrow()
neu_erkrankt <- nv_marked %>% 
	filter(ETS_21 == F) %>% 
	filter(ETS_22 == T) %>% 
	filter(Gefunden == T) %>% 
	nrow()
gesundet <- nv_marked %>% 
	filter(ETS_21 == T) %>% 
	filter(ETS_22 == F) %>% 
	filter(Gefunden == T) %>% 
	nrow()
krank <- nv_marked %>% 
	filter(ETS_21 == T) %>% 
	filter(ETS_22 == T) %>% 
	filter(Gefunden == T) %>% 
	nrow()
gesund_gestorben <- nv_marked %>% 
	filter(ETS_21 == F) %>% 
	filter(Tot_22 == T) %>% 
	filter(Gefunden == T) %>% 
	nrow()
krank_gestorben <- nv_marked %>% 
	filter(ETS_21 == T) %>% 
	filter(Tot_22 == T) %>% 
	filter(Gefunden == T) %>% 
	nrow()
nicht_gefunden_gesund <- nv_marked %>% 
	filter(ETS_21 == F) %>% 
	filter(Gefunden == F) %>% 
	nrow()
nicht_gefunden_krank <-  nv_marked %>% 
	filter(ETS_21 == T) %>% 
	filter(Gefunden == F) %>% 
	nrow()
data.frame(
	" " = c("", 2022, 2022, 2022, 2022),
	" " = c(nrow(nv_marked), "kein ETS", "ETS", "Tot", "nicht gefunden"),
	"2021" = c("kein ETS", gesund,neu_erkrankt, gesund_gestorben, nicht_gefunden_gesund),
	"2021" = c("ETS", gesundet, krank, krank_gestorben, nicht_gefunden_krank),
						 check.names = F
)
```

Wie man sieht gibt es hier ein Problem: Ich habe mehr Eschen im nächsten
Jahr als nicht mehr infiziert eingestuft als ich Eschen als infiziert
wieder erkannt habe. Das weckt erstmal massive Zweifel daran ob das
Bonitursystem überhaupt geklappt hat. Man kann vielleicht trotzdem den
Satz: "Wenn ein Baum 2021 ETS hatte ist es wahrscheinlicher, dass er
2022 ebenfalls krank wird als dass ein bisher gesunder Baum krank wird."
Die einzige Rettung die mir gerade einfällt wäre, dass die Infektionen
im nächsten Jahr einfach nicht mehr so gut zu sehen waren und sie daher
eher als sonstige Schäden eingestuft wurden. Dann müsste ich jetzt die
Mengentabelle erweitern.

Wie viele der Eschen die 2021 krank waren, haben 2022 sonstige Schäden?
(absolut und relativ)

```{r Sonstige Schaeden1, echo=F, warning=F, message=FALSE}
tmp <- nv_marked %>% 
	filter(ETS_21 == T) %>%
	filter(Sonstige.Gruende.tot_22 != 0) %>% 
	nrow(.)
tmp
nv_marked %>% 
	filter(ETS_21 == T) %>%
	nrow(.)
tmp / nv_marked %>% 
	filter(ETS_21 == T) %>%
	nrow(.)
```

Und wie viele der 2021 Gesunden haben 2022 sonstige Schäden? (absolut
und relativ)

```{r Sonstige Schaeden2, echo=F, warning=F, message=FALSE}
tmp <- nv_marked %>% 
	filter(ETS_21 == F) %>%
	filter(Sonstige.Gruende.tot_22 != 0) %>% 
	nrow(.)
tmp
nv_marked %>% 
	filter(ETS_21 == F) %>%
	nrow(.)
tmp / nv_marked %>% 
	filter(ETS_21 == F) %>%
	nrow(.)
```

Und wie viele der Eschen die 2022 krank geworden sind, hatten vorher
bereits sonstige Schäden?

```{r Sonstige Schaeden3, echo=F, warning=F, message=FALSE}
tmp <- nv_marked %>% 
	filter(ETS_22 == T) %>%
	filter(Sonstige.Gruende.tot_22 != 0) %>% 
	nrow(.)
tmp
nv_marked %>% 
	filter(ETS_22 == T) %>%
	nrow(.)
tmp / nv_marked %>% 
	filter(ETS_22 == T) %>%
	nrow(.)
```

Das ist weniger, das ist viel weniger, das heißt ja mehr oder weniger,
dass von den Nekrosen die 2022 verschwunden sind, sehr viele als
sonstige Schäden wieder aufgetaucht sind. Jetzt nüsste man noch schauen
wie viele der Eschen die 2022 "gesund" geworden sind, danach sonstige
Schäden hatten.

```{r gesundet, echo=F, warning=F, message=FALSE}
nv_marked %>% 
	filter(ETS_21 == T) %>% 
	filter(ETS_22 == F) %>% 
	filter(Gefunden == T) %>% 
	filter(Sonstige.Gruende.tot_22 != 0) %>% 
	nrow()
gesundet
nv_marked %>% 
	filter(ETS_21 == T) %>% 
	filter(ETS_22 == F) %>% 
	filter(Gefunden == T) %>% 
	filter(Sonstige.Gruende.tot_22 != 0) %>% 
	nrow() / gesundet
```

Da ich bei den zuwächsen des gesamten Samples auch schon ein paar Verifizierungsschritte gemacht habe, kommt das hier auch nochmal. Zunächst das wenig aufschlussreiche Zuwachs zu Licht und dann noch das bessere: Zuwachs zu Hoehe.

```{r Zuwachs, echo=F, warning=F, message=FALSE}
nv_marked %>% 
	filter(Zuwachs > 0) %>% 
	filter(Tot_22 != T) %>% 
	ggplot() +
	geom_point(aes(x = TSF, y = Zuwachs), size = 3, alpha = 0.2, shape = 16)


nv_marked %>% 
	# filter(Zuwachs > 0) %>% 
	filter(Tot_22 != T) %>% 
	ggplot(aes(x = Hoehe_22, y = Zuwachs)) +
	geom_point(size = 3, alpha = 0.2, shape = 16) +
	geom_smooth()

```

Aber eigentlich ging es ja darum zu sehen ob der Zuwachs geringer oder höher ist wenn ETS ins Spiel kommt. Dafür dient die folgende Graphik. Bei der zweiten Graphik sind alle Eschen raus gefiltert die ETS in einem Terminalen trieb haben oder hatten. Das sollte ja dann hoffentlich die Eschen entfernen die nur kleiner geworden sind weil ihre Spitze abgetrocknet ist.
```{r Zuwachs ~ ETS, echo=F, warning=F, message=FALSE}
nv_marked %>% 
	filter(Zuwachs > -10 & Zuwachs < 40) %>% 
	ggplot(aes(x = Zuwachs)) +
	geom_bar(aes(fill = ETS))

nv_marked %>% 
	filter(Zuwachs > -10 & Zuwachs < 40) %>% 
	filter(!ETS_terminal) %>% 
	ggplot(aes(x = Zuwachs)) +
	geom_bar(aes(fill = ETS))

```

Nun habe ich den Graphen der vor meinem Schreibtisch hängt auch noch für die markierten Eschen nachgebaut. Es sind dieses Mal alle Eschen mit drin, sowohl die die gestorbenen als auch solche mit terminalen Schäden etc. Die Höhenklassen wurden nach den Höhen von 2021 gebildet.

```{r, echo=F, warning=F, message=FALSE, fig.width=10}


## ADAPT DATA  --------------------------------------------
tmp <- nv_marked
tmp$Hoehe_22 <- tmp$Hoehe_22 *10
tmp$Hoehe_21 <- tmp$Hoehe_21 *10
tmp$Zuwachs <- tmp$Zuwachs *10
tmp <- tmp %>% 
	filter(Hoehe_21 <= 500)

## SUMMARIZE DATA BY HEIGHT GROUPS  --------------------------------------------
steps <- seq(from = 0, to = 500, by = 20)
table_ets_hist <- 
	tmp %>% 
	filter(ETS == T) %>% 
	mutate(hist_step = cut(
		x = Hoehe_22,
		breaks = steps,
		labels = steps[1:25] + 10
	)) %>% 
	group_by(hist_step, .drop = F) %>% 
	summarise(growth = mean(Zuwachs, na.rm = T), n = n()) %>% 
	mutate(ETS = T) 

table_hist <-
	tmp %>% 
	filter(ETS == F) %>% 
	mutate(hist_step = cut(
		x = Hoehe_22,
		breaks = steps,
		labels = steps[1:25] + 10
	)) %>% 
	group_by(hist_step, .drop = F) %>% 
	summarise(growth = mean(Zuwachs, na.rm = T), n= n()) %>% 
	mutate(ETS = F) 

table_both_hist <- rbind(table_hist, table_ets_hist)
table_both_hist$hist_step <- as.numeric(as.character(table_both_hist$hist_step))

## GGPLOT  ---------------------------------------------------------------------
plot <-
	ggplot(table_both_hist) +
	geom_col(aes(
		x = hist_step,
		y = n,
		fill = ETS
	)) +
	geom_point(aes(x = hist_step, y = growth*0.5, color = ETS), size = 2) +
	geom_smooth(aes(x = hist_step, y = growth*0.5, color = ETS), method = "gam") +
	scale_y_continuous(name = "Anzahl [total = 1461]",
										 sec.axis =  sec_axis(trans = ~ 2*.,
										 										 name = "Durchschnittl. Zuwachs [mm pro Jahr]"),
										 limits = c(-50, 250)) +
	scale_x_continuous(
		name = "Hoehenklassen [mm]",
		breaks = seq(0, 500, 25),
		labels = seq(0, 500, 25)
	) +
	scale_fill_manual(name = "Anzahl",
										values = c("gray60", "red4"),
										labels = c("Ohne ETS", "Mit ETS")) +
	scale_color_manual(name = "Zuwachs", 
										 values = c("black", "red3"),
										 labels = c("Ohne ETS", "Mit ETS")) +
	annotate(
		geom = "text",
		x = 200,
		y = 150,
		hjust = 0,
		label = "> filter (Höhe < 500)",
		size = 4
	)
ggsave(plot = plot, 
 			 filename = "EXPORT/Goe_Lau/figures/Hoehenverteilung_Zuwachs_ETS_marked.pdf",
 			 units = "mm", width = 300, height = 150)
plot

```

